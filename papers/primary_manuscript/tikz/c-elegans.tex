\begin{tikzpicture}
  \begin{scope}[rotate=90]
    % Read node coordinates and create nodes
    \csvreader[head to column names]{data/processed/vertices_B_factor=1.5_adj_matrix_source=c-elegans_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_step=560000_time_steps=8000000.csv}{}%
    {%
      \node[draw, circle, draw=none, index of colormap=\strategyIndex of strategycolors, fill=., inner sep=1.5] (\index) at (\x, \y) {};
    }

    \begin{scope}[on background layer]
      % Decrease total opacity to prevent high opacity of overlapping edges
      \begin{scope}[transparency group,opacity=.75]
      % Read edges and draw connections between nodes
      \csvreader[head to column names]{data/processed/edges_adj_matrix_source=c-elegans.csv}{}%
      {%
        % Make individual opacity low; multiple overlapping edges can still have high opacity
        \ifthenelse{\equal{\src}{\dst}}
        { \path[in=-45,out=45,loop,->,>=latex,line width=0.1,opacity=0.2] (\src) edge (\dst);}
        { \path[->,>=latex,line width=0.1,opacity=0.2] (\src) edge (\dst);}
      }
      \end{scope}
    \end{scope}
  \end{scope}
  \node [text width=1cm,anchor=north west,fill=white,fill opacity=0.7,text opacity=1] at (-2,4) {\subcaption{\label{fig:graph}}};

  \begin{scope}[shift={(4,0)}]
  \begin{groupplot}[width=0.5\textwidth, group style={group size=1 by 3}, fraction communicative chart]
      \nextgroupplot
        \node [text width=1cm,anchor=north west] at (rel axis cs: 0,1) {\subcaption{\label{fig:comm-frac_celegans-full}}};
        \addplot table{data/processed/cumulative/adj_matrix_source=c-elegans_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
      \nextgroupplot
        \node [text width=1cm,anchor=north west] at (rel axis cs: 0,1) {\subcaption{\label{fig:comm-frac_celegans-unweighted}}};
        \addplot table{data/processed/cumulative/adj_matrix_source=c-elegans-unweighted_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
      \nextgroupplot
        \node [text width=1cm,anchor=north west] at (rel axis cs: 0,1) {\subcaption{\label{fig:comm-frac_celegans-undirected}}};
        \addplot table{data/processed/cumulative/adj_matrix_source=c-elegans-undirected_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
  \end{groupplot}
  \end{scope}

  \begin{scope}[shift={(-2,-8)}]
    \begin{axis}[
      width=0.35\textwidth,
      ymin=0,
      ymax=1,
      enlarge y limits=0.05,
      hide x axis,
      axis  y  line*=right,
      scale only axis, % ensure overlaid axes align
      y tick label style=magenta,
      every axis plot/.append style={
        line width=1pt,
        line join=bevel,
      },
    ]
    \node [text width=1cm,anchor=north west] at (rel axis cs: 0,1) {\subcaption{\label{fig:time-series_celegans-full}}};
    \addplot [magenta] table[y=order_parameter] {data/processed/timeseries_statistics/B_factor=1.5_adj_matrix_source=c-elegans_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv};
    \end{axis}
    \begin{axis}[
      name=timeseries,
      width=0.35\textwidth,
      grid,
      ymin=0,
      ymax=1,
      enlarge y limits=0.05,
      axis y line*=left,
      ylabel style={align=center},
      scale only axis, % ensure overlaid axes align
      every x tick scale label/.style={at={(xticklabel cs:1)},anchor=south west}, % Move xlabel exponent
      shader=flat corner, %disable color mixing
      every axis plot/.append style={
        only marks,
        mark size=0.75pt,
      },
      scatter,
      scatter src=explicit symbolic,
      scatter/classes={%
        harmony={draw=Paired-G,fill=Paired-G},
        chicken={draw=Paired-F,fill=Paired-F},
        battle={draw=Paired-E,fill=Paired-E},
        hero={draw=Paired-H,fill=Paired-H},
        compromise={draw=Paired-C,fill=Paired-C},
        concord={draw=Paired-D,fill=Paired-D},
        staghunt={draw=Paired-B,fill=Paired-B},
        dilemma={draw=Paired-K,fill=Paired-K},
        deadlock={draw=Paired-A,fill=Paired-A},
        assurance={draw=Paired-J,fill=Paired-J},
        coordination={draw=Paired-I,fill=Paired-I},
        peace={draw=Paired-L,fill=Paired-L},
        all_communicative={draw=lightgray,fill=lightgray},
        all_noncommunicative={draw=darkgray,fill=darkgray}
      },
  ]
    \addplot table [y=communicative_fraction, meta=game_type] {data/processed/timeseries_statistics/B_factor=1.5_adj_matrix_source=c-elegans_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv};
    \end{axis}
  % Make an invisible axis to create a legend that is the union
  % of all the data table's column names
  \begin{axis}[
    hide axis,
    % Needs xmin/xmax/ymin/ymax to create legend entries
    xmin=10,
    xmax=50,
    ymin=0,
    ymax=0.4,
    legend columns=1,
    legend to name={CElegansLegend},
    ]
    \def\gameTypes{}
    % Prevent underscore from counting as subscript
    \catcode`\_=12
    % Note: these table names must be the same as those in the groupplots
    \pgfplotsforeachungrouped\tablename in {data/processed/timeseries_statistics/B_factor=1.5_adj_matrix_source=well-mixed_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv,data/processed/timeseries_statistics/B_factor=1.5_adj_matrix_source=c-elegans_nb_phases=20_payoff_update_method=single-update_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv} {
      % Read table
      \pgfplotstableread\tablename\loadtable
      % Loop over each column
      \pgfplotstableforeachcolumnelement{game_type}\of\loadtable\as\gameType
      {
        \ifnum\pgfplotstablerow=0\else%
          \ifx\gameTypes\empty
            % Add first game type to empty gameTypes
            \edef\gameTypes{\gameType}
          \else
            % Add game type to gameTypes if not already there
            \IfSubStr{\gameTypes}{\gameType}{}{\edef\gameTypes{\gameTypes,\gameType}}
          \fi
        \fi
      }
    }

    % Add all entries to legend
    \expandafter\pgfplotsinvokeforeach\expandafter{\gameTypes}{%
      \addlegendimage{ybar, single ybar legend, #1, draw=black}%
      \addlegendentry{#1}%
    }%
    % Also add order parameter
    \addlegendimage{ybar, single ybar legend, fill=magenta, draw=black}%
    \addlegendentry{order parameter}%
  \end{axis}
  \path (timeseries.south west) -- node[below={1cm}]{\pgfplotslegendfromname{CElegansLegend}} (timeseries.south east);
  \end{scope}
\end{tikzpicture}
