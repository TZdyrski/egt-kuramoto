%! TeX program = lualatex
\documentclass[tikz]{standalone}

% Import custom style file containing common packages and options
\usepackage{../preamble}

% Import tikz options and preamble
\input{preamble}

\begin{document}
\begin{tikzpicture}
  \begin{scope}[rotate=90]
    % Read node coordinates and create nodes
    \csvreader[head to column names]{../../data/processed/graph_structure/vertices_B_to_c=1.5_adj_matrix_source=c-elegans_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_step=560000_time_steps=8000000.csv}{}%
    {%
      \node[draw, circle, draw=none, index of colormap=\strategyIndex of strategycolors, fill=., inner sep=1.5] (\index) at (\x, \y) {};
    }

    \begin{scope}[on background layer]
      % Decrease total opacity to prevent high opacity of overlapping edges
      \begin{scope}[transparency group,opacity=.75]
      % Read edges and draw connections between nodes
      \csvreader[head to column names]{../../data/processed/graph_structure/edges_adj_matrix_source=c-elegans.csv}{}%
      {%
        % Make individual opacity low; multiple overlapping edges can still have high opacity
        \ifthenelse{\equal{\src}{\dst}}
        { \path[in=-45,out=45,loop,->,>=latex,line width=0.1,opacity=0.2] (\src) edge (\dst);}
        { \path[->,>=latex,line width=0.1,opacity=0.2] (\src) edge (\dst);}
      }
      \end{scope}
    \end{scope}
  \end{scope}

  \begin{scope}[shift={(4,1)}]
  \begin{groupplot}[
    width=0.5\textwidth,
    group style={group size=1 by 3},
    fraction communicative chart,
    ylabel style={blue},
    y tick label style=blue,
    ]
      \nextgroupplot
        \addplot table{../../data/processed/cumulative/adj_matrix_source=c-elegans_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
      \nextgroupplot
        \addplot table{../../data/processed/cumulative/adj_matrix_source=c-elegans-unweighted_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
      \nextgroupplot[xlabel={Maximum joint benefit $B_0$}]
        \addplot table{../../data/processed/cumulative/adj_matrix_source=c-elegans-undirected_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=200000000_type=simulation.csv};
  \end{groupplot}
  \end{scope}

  \begin{scope}[shift={(-2,-7)}]
    \begin{axis}[
      width=0.35\textwidth,
      ymin=0,
      ymax=1,
      enlarge y limits=0.05,
      hide x axis,
      axis  y  line*=right,
      scale only axis, % ensure overlaid axes align
      y tick label style=magenta,
      every axis plot/.append style={
        line width=1pt,
        line join=bevel,
      },
      ylabel={Order Parameter},
      ylabel style={magenta},
    ]
    \addplot [magenta] table[y=order_parameter] {../../data/processed/timeseries_statistics/B_to_c=1.5_adj_matrix_source=c-elegans_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv};
    \end{axis}
    \begin{axis}[
      name=timeseries,
      width=0.35\textwidth,
      grid,
      ymin=0,
      ymax=1,
      enlarge y limits=0.05,
      axis y line*=left,
      ylabel style={align=center},
      scale only axis, % ensure overlaid axes align
      every x tick scale label/.style={at={(xticklabel cs:1)},anchor=south west}, % Move xlabel exponent
      shader=flat corner, %disable color mixing
      every axis plot/.append style={
        only marks,
        mark size=0.75pt,
      },
      xlabel={Time},
      ylabel={Communiciative frequency $f_{\text{comm}}$},
      ylabel style={blue},
      y tick label style=blue,
      scatter,
      scatter src=explicit symbolic,
      scatter/classes={%
        harmony={draw=Paired-G,fill=Paired-G},
        chicken={draw=Paired-F,fill=Paired-F},
        battle={draw=Paired-E,fill=Paired-E},
        hero={draw=Paired-H,fill=Paired-H},
        compromise={draw=Paired-C,fill=Paired-C},
        concord={draw=Paired-D,fill=Paired-D},
        staghunt={draw=Paired-B,fill=Paired-B},
        dilemma={draw=Paired-K,fill=Paired-K},
        deadlock={draw=Paired-A,fill=Paired-A},
        assurance={draw=Paired-J,fill=Paired-J},
        coordination={draw=Paired-I,fill=Paired-I},
        peace={draw=Paired-L,fill=Paired-L},
        all_communicative={draw=lightgray,fill=lightgray},
        all_noncommunicative={draw=darkgray,fill=darkgray}
      },
  ]
    \addplot table [y=communicative_fraction, meta=game_type] {../../data/processed/timeseries_statistics/B_to_c=1.5_adj_matrix_source=c-elegans_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv};
    \end{axis}
  % Make an invisible axis to create a legend that is the union
  % of all the data table's column names
  \begin{axis}[
    hide axis,
    % Needs xmin/xmax/ymin/ymax to create legend entries
    xmin=10,
    xmax=50,
    ymin=0,
    ymax=0.4,
    legend columns=-1,
    legend to name={CElegansLegend},
    ]
    \def\gameTypes{}
    % Prevent underscore from counting as subscript
    \catcode`\_=12
    % Note: these table names must be the same as those in the groupplots
    \pgfplotsforeachungrouped\tablename in {../../data/processed/timeseries_statistics/B_to_c=1.5_adj_matrix_source=c-elegans_beta_to_B=0.95_cost=0.1_mutation_rate=0.0001_nb_phases=20_selection_strength=0.2_symmetry_breaking=0.75_time_steps=800000.csv} {
      % Read table
      \pgfplotstableread\tablename\loadtable
      % Loop over each column
      \pgfplotstableforeachcolumnelement{game_type}\of\loadtable\as\gameType
      {
        \ifnum\pgfplotstablerow=0\else%
          \ifx\gameTypes\empty
            % Add first game type to empty gameTypes
            \edef\gameTypes{\gameType}
          \else
            % Add game type to gameTypes if not already there
            \IfSubStr{\gameTypes}{\gameType}{}{\edef\gameTypes{\gameTypes,\gameType}}
          \fi
        \fi
      }
    }

    % Sort legend entries alphanumerically
    \expandafter\alphabubblesort\expandafter{\gameTypes}

    % Add all entries to legend
    \expandafter\pgfplotsinvokeforeach\expandafter{\sortedlist}{%
      \ifthenelse{\equal{#1}{all_communicative}}
        {
          \addlegendimage{ybar, single ybar legend, all_communicative, draw=black}%
          \addlegendentry{all-C}%
        }
        {
          \ifthenelse{\equal{#1}{all_noncommunicative}}
          {
            \addlegendimage{ybar, single ybar legend, all_noncommunicative, draw=black}%
            \addlegendentry{all-N}%
          }
          {
            \addlegendimage{ybar, single ybar legend, #1, draw=black}%
            \addlegendentry{#1}%
          }
        }
    }%

    % Also add order parameter
    \addlegendimage{ybar, single ybar legend, fill=magenta, draw=black}%
    \addlegendentry{order parameter}%
  \end{axis}
  \path (timeseries.south west) -- node[below={1cm}]{\pgfplotslegendfromname{CElegansLegend}} (timeseries.south east);
  \end{scope}
\end{tikzpicture}
\end{document}
