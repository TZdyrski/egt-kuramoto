\ProvidesPackage{preamble}

%% Preamble
\usepackage[T1]{fontenc}

% Macros
%\usepackage{ifdraft} % allow checking if in draft mode
%\usepackage{xparse} % allow parsing of complex macros
%\usepackage{etoolbox} % enable tools for writing macros
\usepackage{xstring} % add string manipulation

%%% Page Dimensions
%\usepackage{geometry} % change page dimensions
%\geometry{letterpaper}
%\geometry{margin=1in} % set margins

%% Tables
\usepackage{booktabs} % improve table quality
%\usepackage{tabularx} % allow for dynamic table sizing
%\usepackage{spreadtab} % enable calculations inside tables

%% Lists
%\usepackage[inline,shortlabels]{enumitem} % improve handling of item lists

%% Columns
%\usepackage{multicol} % allow multiple columns of text

%% Math
\usepackage{amsmath} % improve math output
\usepackage{amssymb} % additional math symbols
\usepackage{mathtools} % add additional math symbols
\usepackage{siunitx} % improve typesetting of SI units
%\usepackage{bm} % improve bold rendering of math symbols
%\usepackage{tensor} % improve handling of tensor indices
\usepackage{nicematrix} % improve matrix typesetting capabilities

%% Figures
\usepackage{graphicx} % improve graphics inclusion
%\usepackage{float} % allow for floating graphics
%\usepackage[labelsep=period,tableposition=top]{caption} % allow changes to figure captions
\usepackage{subcaption} % allow inclusion of subfigures
\renewcommand\thesubfigure{(\alph{subfigure})} % put parentheses around references
\captionsetup[subfigure]{labelformat=simple} % don't put extra parentheses around label
%\usepackage{svg} % allow for inclusion of svg vector images
\usepackage{tikz} % allow programatically-created graphics
%\usetikzlibrary{positioning} % add positioning commands to tikz
%\usetikzlibrary{calc} % add complex coordinate calculations to tikz
%\usetikzlibrary{patterns} % allow patterns/shading in tikz
\usepackage{pgfplots} % improve Tikz plot handling
\pgfplotsset{compat=1.18} % use newer features
\usepgfplotslibrary{groupplots} % add group plots
\usepgfplotslibrary{colorbrewer} % use Brewer colormaps
\usepgfplotslibrary{fillbetween} % add filling between paths
\usetikzlibrary{backgrounds} % allow drawing on background layer
\usepackage{csvsimple} % allow importing of CSV data
%\usepackage{xifthen} % improve Tikz conditional logic
%\usepackage{media9} % allow for inclusion of movies
%\usepackage{import} % load files relative to directory
%\usepackage{standalone} % allow creation of standalone figures

%% Source Code
%\usepackage{listings} % add display of source code

%% Fonts
\usepackage{lmodern} % add additional font size

%% Lorem Ipsum
%\usepackage[latin, english]{babel} % add latin for lorem ipsum
%\usepackage{blindtext} % add lorem ipsum

%% Languanges
%\usepackage{CJKutf8} % add support for chinese, japanese, and japanese %characters

%% Special Symbols
\usepackage{physics2} % common symbols used in physics
\usephysicsmodule{ab,ab.legacy,qtext.legacy}
%\usepackage{ar} % add the aspect ratio symbol
%\usepackage{chemformula} % allow typesetting of chemical formulas
%\usepackage{orcidlink}

%% Formatting
%\usepackage[onehalfspacing]{setspace} % change line spacing
%\usepackage{nth} % allow typesetting of ordinals
\usepackage{microtype} % improved kerning and formatting
%\usepackage{epigraph} % allow typesetting of epigraphs
%\usepackage{lineno} % turn on line numbering

%% Comments
%\usepackage{verbatim} % add block comments

%% Emphasis
%\usepackage{color} % add colored text
\usepackage[abbreviations, xlatin]{foreign} % define commands \ie \eg and more
\defasforeign[vs]{vs.} % Define abbreviation of versus
%\usepackage[makeroom]{cancel} % add strikethrough to cancel equations

%% Citations and References
%\usepackage{authblk} % allow author/affiliation-style in author block
%\usepackage{csquotes} % smart quotes, recommended for use with biblatex
%\usepackage{natbib} % allow use of bibliography
%\usepackage[backend=biber,
%% PHYS
%            style=phys,
%            articletitle=false,
%            biblabel=brackets,
%            chaptertitle=false,
%            pageranges=false,
%            sorting=none,
%% SIO
%            style=authoryear-comp,
%            sortcites,
%            sorting=none,
%            url=false,
%            bibencoding=utf8]{biblatex} % improved bibliography
%\usepackage{hyperref} % hyperlink references. Make sure to load last
%\hypersetup{colorlinks, % remove borders, but color links
%            linkcolor=blue,
%            citecolor=red, % PHYS
%            citecolor=blue, % SIO
%            urlcolor=blue,
%            pdfencoding=auto, %enable unicode characters in bookmarks
%            }
\usepackage[capitalize,sort]{cleveref} % improve references (load laster than hyperref)
%\crefname{subsubsection}{subsection}{subsections} % redefine subsubsection to print as just subsection, which is less ugly
%\Crefname{subsubsection}{Subsection}{Subsections}

%% Abbreviate reference labels
%\crefname{equation}{Eq.}{Eqs.}
%\Crefname{equation}{Equation}{Equations}
%\crefname{section}{Sec.}{Secs.}
%
%% Define macro giving cref's representation of figure
%\newcommand{\figname}{\cref@figure@name}
%\newcommand{\Figname}{\Cref@figure@name}
%\newcommand{\figsname}{\cref@figures@name}
%\newcommand{\Figssname}{\Cref@figures@name}
%
%% Define macro giving cref's representation of equation
%\newcommand{\eqname}{\cref@equation@name}
%\newcommand{\Eqname}{\Cref@equation@name}
%\newcommand{\eqsname}{\cref@equations@name}
%\newcommand{\Eqsname}{\Cref@equations@name}
%
%% Change "Figure" to "FIG"
%\renewcommand{\figurename}{FIG.}
%
%% Ensure cleveref uses a serial comma
%\newcommand{\creflastconjunction}{, and\nobreakspace}

% Define new commands \pcref and \pCref corresponding to \cref and \Cref
% but without the parentheses around the subfigures
\newcommand{\eqlabelleft}{(}
\newcommand{\eqlabelright}{)}
\DeclareRobustCommand{\pcref}[1]{%
  \begingroup%
  \renewcommand{\eqlabelleft}{}\renewcommand{\eqlabelright}{}%
  \cref{#1}%
  \endgroup%
}
\DeclareRobustCommand{\pCref}[1]{%
  \begingroup%
  \renewcommand{\eqlabelleft}{}\renewcommand{\eqlabelright}{}%
  \Cref{#1}%
  \endgroup%
}
\creflabelformat{equation}{\eqlabelleft#2#1#3\eqlabelright}

%% For subfigures, make alphabetic part italic and change "fig 2(a) and
%% 2(b)" to "fig 2(a,b)"
%\crefformat{subfigure}%
%  {figure~#2\StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}\eqlabelright#3}%
%\Crefformat{subfigure}%
%  {Figure~#2\StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}\eqlabelright#3}%
%
%\crefrangeformat{subfigure}{figures~#3%
%  \StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}#4%
%  --#5\textit{\crefstripprefix{#1}{#2}}\eqlabelright#6}
%\Crefrangeformat{subfigure}{Figures~#3%
%  \StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}#4%
%  --#5\textit{\crefstripprefix{#1}{#2}}\eqlabelright#6}
%
%\crefmultiformat{subfigure}%
%  % For the first element, italicize the final character (assumed to be
%  % the single-letter subfigure label)
%  {\edef\crefstripprefixinfo{#1}figures~#2\StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}#3}%
%  % For all the others, subtract off the common prefix with the first
%  % element
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}\eqlabelright#3}%
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}#3}%
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}\eqlabelright#3}
%\Crefmultiformat{subfigure}%
%  {\edef\crefstripprefixinfo{#1}Figures~#2\StrGobbleRight{#1}{1}\eqlabelleft\textit{\StrRight{#1}{1}}#3}%
%  % For all the others, subtract off the common prefix with the first
%  % element
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}\eqlabelright#3}%
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}#3}%
%  {,#2\textit{\crefstripprefix{\crefstripprefixinfo}{#1}}\eqlabelright#3}

%% Allow \cref{sub@label} to just give the subcaption label "fig a" instead of
%% the usual "fig 1a"
%% Source: https://tex.stackexchange.com/questions/333223/combining-cleveref-and-subref
%\makeatletter
%\@ifpackageloaded{subcaption}{%
%\renewcommand*\subcaption@@label[2]{%
%  \@bsphack\begingroup
%    \subcaption@ORI@label#1{#2}%
%    \let\SK@\@gobbletwo
%    \protected@edef\@currentlabel{\csname thesub\@captype\endcsname}%
%    \protected@edef\cref@currentlabel{%
%      [subs\@captype][\arabic{sub\@captype}][\cref@result]%
%      \csname thesub\@captype\endcsname}%
%    \subcaption@ORI@label#1{sub@#2}%
%  \endgroup\@esphack}%
%}
%\makeatother
%\crefname{subsfigure}{figure}{figures}
%\labelcrefformat{subsfigure}{#2\textit{#1}#3}
%\labelcrefrangeformat{subsfigure}%
%  {#3\textit{\crefstripprefix{#2}{#1}}#4--#5\textit{\crefstripprefix{#1}{#2}}#6}
%\labelcrefmultiformat{subsfigure}%
%  {#2\textit{#1}#3}%
%  {,#2\textit{#1}#3}%
%  {,#2\textit{#1}#3}%
%  {,#2\textit{#1}#3}

%% Glossaries
%\usepackage[acronym, xindy, nonumberlist, nopostdot, nomain]{glossaries} % add glossaries and nomenclature lists (load after hyperref)
%\newglossary[slg]{symbols}{symb}{sbl}{List of Symbols} % define new glossary for symbols
%\makeglossaries % generate glossaries
\usepackage{glossaries-extra} % use extra glossary features

%% Set miscellaneous parameters
%\setcounter{tocdepth}{3} % increase TOC depth to include subsubsections
%\setlength{\columnseprule}{0.4pt} % set thickness of rule separating columns
\delimitershortfall=-2pt % cause nested parentheses to be smaller
%\renewcommand{\CancelColor}{\color{red}} % change color of arrow in package cancel

%% Redefine commands
%\renewcommand*{\vec}[1]{\mathbf{\bm{#1}}}
%\renewcommand*{\vu}[1]{\mathbf{\bm{\hat{#1}}}}

%% New commands
%% Force bibliography title to take up full page even though citations
%% are in two columns
%\newcommand\twocolprintbibliography[2][0pt]{%
%  \begingroup\setlength{\multicolsep}{#1}%
%  \begin{multicols}{2}[{\printbibheading[title={#2}]}]
%  \printbibliography[heading=none]
%  \end{multicols}\endgroup}


%% Remove trailing period if newcommand followed by sentence period
%\catcode`@=11
%\def\checkperiod{\futurelet\next\check@period}
%\def\check@period{%
%  \if\noexpand\next.%
%    \text{\spacefactor\sfcode`.}
%    \expandafter\@gobble
%  \fi}
%\long\def\@gobble#1{}
%\def\@{\spacefactor\@m}
%\catcode`@=12
%
%\newcommand{\cc}{\text{c.c.}\checkperiod} % complex conjugate abbreviation

% Define ddbar as a differential with a slash (like hbar)
%\newcommand\ddbar[2][]{{\def\diffd{\mathchar'26\mkern-12mu\text{d}}\dd[#1]{#2}}}

%% Allow SIrange or numrange to be used in math mode
%\sisetup{mode=text,range-phrase = \textup{--}, separate-uncertainty=true}

%% Use an en-dash for cleveref ranges
%\newcommand{\crefrangeconjunction}{--}

% Define command to import pgf figure from subdirectory
%\newcommand\inputpgf[2]{{
%\let\pgfimageWithoutPath\pgfimage
%\renewcommand{\pgfimage}[2][]{\pgfimageWithoutPath[##1]{#1/##2}}
%\input{#1/#2}
%}}

%%% Match math environments to work with lineno (wrap in linenomath so
%%% that the preceding text paragraphs correctly get numbered)
%%% Source: https://tex.stackexchange.com/questions/461186/how-to-use-lineno-with-amsmath-align
%% Patch AMS math environment:
%\newcommand*\linenomathpatchAMS[1]{%
%  \expandafter\pretocmd\csname #1\endcsname {\linenomathAMS}{}{}%
%  \expandafter\pretocmd\csname #1*\endcsname{\linenomathAMS}{}{}%
%  \expandafter\apptocmd\csname end#1\endcsname {\endlinenomath}{}{}%
%  \expandafter\apptocmd\csname end#1*\endcsname{\endlinenomath}{}{}%
%}
%
%% Definition of \linenomathAMS depends on whether the mathlines option is provided
%\expandafter\ifx\linenomath\linenomathWithnumbers
%  \let\linenomathAMS\linenomathWithnumbers
%  % The following line gets rid of an extra line numbers at the bottom:
%  \patchcmd\linenomathAMS{\advance\postdisplaypenalty\linenopenalty}{}{}{}
%\else
%  \let\linenomathAMS\linenomathNonumbers
%\fi
%
%\linenomathpatchAMS{gather}
%\linenomathpatchAMS{multline}
%\linenomathpatchAMS{align}
%\linenomathpatchAMS{alignat}
%\linenomathpatchAMS{flalign}

%% Allows referencing phantom subfigures, i.e. when (a), (b) are part of an
%% image itself. Must be followed by \vspace{-2\baselineskip}
%% Source: https://tex.stackexchange.com/a/557032
%\newcommand{\phantomsubfloat}[1]{
%    {% apply caption setup only temporarily
%        \captionsetup[subfigure]{labelformat=empty}
%        \subfloat[][]{#1}
%    }%
%}

%% Create line number labelling command
%% Define a new environment for labeling sections of text by line numbers
%% Environment can be starred (\begin{LineLabel}*{...}) to turn off line
%% number generation and only color text (if uncolor=False); this is
%% useful for regions that don't have linenumbers (eg captions).
%% The mandatory option provides a label that can later be used for
%% referencing with the \LineRef{...} command.
%% The option command is a keyword argument 'uncolor': if [uncolor] or
%% [uncolor=True] is passed, the section will be labeled but not colored;
%% if no option (default) or [uncolor=False] is passed, the section will
%% be labeled and colored blue.
%%
%% Source: https://tex.stackexchange.com/a/444150
%\ExplSyntaxOn
%\NewDocumentEnvironment{LineLabel}{s m O{}}{%
%  \IfBooleanTF{#1}{%
%  % If starred, don't create a linelabel (useful for environments
%  % without line numbers (eg. captions)
%  }{%
%  % If not starred, create a linelabel with label <mandatory argument>-a
%    \linelabel{#2-a}%
%  }%
%  \keys_set:nn { linelabel/LineLabel }%
%  {%
%    uncolor=false, % initialize to false
%    #3%
%  }%
%  \bool_if:NTF \l_linelabel_LineLabel_uncolor_bool%
%  {%
%  }%
%  {%
%    % Color the environment blue
%    \color{blue}%
%  }%
%  \ignorespaces%
%}%
%{%
%  \ignorespacesafterend%
%  \IfBooleanTF{#1}{%
%  }{%
%  % If not starred, create a linelabel with label <mandatory argument>-b
%    \linelabel{#2-b}%
%  }%
%}%
%\keys_define:nn { linelabel/LineLabel }%
%{%
% uncolor .bool_set:N = \l_linelabel_LineLabel_uncolor_bool,%
% uncolor .default:n  = true,%
%}
%\ExplSyntaxOff

%\newcommand{\crefor}[1]{%
%  {% start a group
%   \providecommand{\crefpairconjunction}{}% initialize
%   \renewcommand{\crefpairconjunction}{~or~}% want `or'
%   \cref{#1}%
%  }% end the group
%}

%% Use italic d for integrand
%\renewcommand*{\dd}[1]{d#1}

%% Remove space between consecutive citations
%\newlength\mylen
%\settowidth\mylen{\space}
%\setcitestyle{citesep={,\kern-\mylen}}

%% Change figure caption label from "Figure" to "FIG."
%\addto\captionsenglish{\renewcommand{\figurename}{FIG.}}

%% Change table caption label from "Table" to "TABLE"
%\addto\captionsenglish{\renewcommand{\tablename}{TABLE}}

%% Remove space before percent sign
%\DeclareSIUnit[quantity-product = ]\percent{\char`\%}

%% Place table caption above table
%\usepackage{float}
%\floatstyle{plaintop}
%\restylefloat{table}
